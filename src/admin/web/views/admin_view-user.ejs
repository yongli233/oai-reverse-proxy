<%- include("partials/shared_header", { title: "View User - OAI Reverse Proxy Admin" }) %>
<h1>View User</h1>
<<<<<<< HEAD
=======

>>>>>>> upstream/main
<table class="striped">
  <thead>
    <tr>
      <th scope="col">Key</th>
      <th scope="col" colspan="2">Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">Token</th>
<<<<<<< HEAD
      <td><%- user.token %></td>
      <td class="actions">
        <a title="Rotate" id="rotate-token" href="#" data-token="<%= user.token %>">🔄️</a>
      </td>
=======
      <td colspan="2"><%- user.token %></td>
>>>>>>> upstream/main
    </tr>
    <tr>
      <th scope="row">Nickname</th>
      <td><%- user.nickname ?? "none" %></td>
      <td class="actions">
        <a title="Edit" id="edit-nickname" href="#" data-field="nickname" data-token="<%= user.token %>">✏️</a>
      </td>
    </tr>
    <tr>
      <th scope="row">Type</th>
      <td><%- user.type %></td>
      <td class="actions">
        <a title="Edit" id="edit-type" href="#" data-field="type" data-token="<%= user.token %>">✏️</a>
      </td>
    </tr>
    <tr>
      <th scope="row">Prompts</th>
      <td colspan="2"><%- user.promptCount %></td>
    </tr>
    <tr>
      <th scope="row">Created At</th>
      <td colspan="2"><%- user.createdAt %></td>
    </tr>
    <tr>
      <th scope="row">Last Used At</th>
      <td colspan="2"><%- user.lastUsedAt || "never" %></td>
    </tr>
    <tr>
      <th scope="row">Disabled At</th>
      <td><%- user.disabledAt %></td>
      <td class="actions">
        <% if (user.disabledAt) { %>
        <a title="Unban" href="#" class="unban" data-token="<%= user.token %>">🔄️</a>
        <% } else { %>
        <a title="Ban" href="#" class="ban" data-token="<%= user.token %>">🚫</a>
        <% } %>
      </td>
    </tr>
    <tr>
      <th scope="row">Disabled Reason</th>
      <td><%- user.disabledReason %></td>
      <% if (user.disabledAt) { %>
      <td class="actions">
<<<<<<< HEAD
        <a title="Edit" id="edit-disabledReason" href="#" data-field="disabledReason" data-token="<%= user.token %>">✏️</a>
=======
        <a title="Edit" id="edit-disabledReason" href="#" data-field="disabledReason"
          data-token="<%= user.token %>">✏️</a>
>>>>>>> upstream/main
      </td>
      <% } %>
    </tr>
    <tr>
      <th scope="row">IP Address Limit</th>
      <td><%- (user.maxIps ?? maxIps) || "Unlimited" %></td>
      <td class="actions">
        <a title="Edit" id="edit-maxIps" href="#" data-field="maxIps" data-token="<%= user.token %>">✏️</a>
      </td>
    </tr>
    <tr>
      <th scope="row">IPs</th>
      <td colspan="2"><%- include("partials/shared_user_ip_list", { user, shouldRedact: false }) %></td>
    </tr>
    <tr>
<<<<<<< HEAD
      <th scope="row">Admin Note <span title="Unlike nickname, this is not visible to or editable by the user">🔒</span></th>
=======
      <th scope="row">Admin Note <span title="Unlike nickname, this is not visible to or editable by the user">🔒</span>
      </th>
>>>>>>> upstream/main
      <td><%- user.adminNote ?? "none" %></td>
      <td class="actions">
        <a title="Edit" id="edit-adminNote" href="#" data-field="adminNote" data-token="<%= user.token %>">✏️</a>
      </td>
    </tr>
    <% if (user.type === "temporary") { %>
    <tr>
      <th scope="row">Expires At</th>
      <td colspan="2"><%- user.expiresAt %></td>
    </tr>
    <% } %>
  </tbody>
</table>

<<<<<<< HEAD
<form style="display: none" id="current-values">
=======
<form style="display:none" id="current-values">
>>>>>>> upstream/main
  <input type="hidden" name="token" value="<%- user.token %>" />
  <% ["nickname", "type", "disabledAt", "disabledReason", "maxIps", "adminNote"].forEach(function (key) { %>
  <input type="hidden" name="<%- key %>" value="<%- user[key] %>" />
  <% }); %>
</form>

<h3>Quota Information</h3>
<% if (quotasEnabled) { %>
<form action="/admin/manage/refresh-user-quota" method="POST">
  <input type="hidden" name="token" value="<%- user.token %>" />
  <input type="hidden" name="_csrf" value="<%- csrfToken %>" />
  <button type="submit" class="btn btn-primary">Refresh Quotas for User</button>
</form>
<<<<<<< HEAD
<% } %>
<%- include("partials/shared_quota-info", { quota, user }) %>
=======
<% } %> <%- include("partials/shared_quota-info", { quota, user }) %>
>>>>>>> upstream/main

<p><a href="/admin/manage/list-users">Back to User List</a></p>

<script>
<<<<<<< HEAD
  document.querySelector("td.actions a#rotate-token").addEventListener("click", function (e) {
    e.preventDefault();
    const token = e.target.dataset.token;

    if (confirm(`Are you sure you want to rotate for this token?`)) {
      fetch(`/admin/manage/rotate-token/${token}`, {
        method: "POST",
        credentials: "same-origin",
        body: JSON.stringify({ _csrf: document.querySelector("meta[name=csrf-token]").getAttribute("content") }),
        headers: { "Content-Type": "application/json", Accept: "application/json" },
      })
        .then((res) => Promise.all([res.ok, res.json()]))
        .then(([ok, json]) => {
          const url = new URL(window.location.href);
          url.pathname = `/admin/manage/view-user/${json.newToken}`;

          const params = new URLSearchParams();
          if (!ok) {
            params.set("flash", `Error: ${json.error.message}`);
          } else {
            params.set("flash", `Success: Token rotated.`);
          }

          url.search = params.toString();
          window.location.replace(url);
        });
    }
  });

=======
>>>>>>> upstream/main
  document.querySelectorAll("td.actions a[data-field]").forEach(function (a) {
    a.addEventListener("click", function (e) {
      e.preventDefault();
      const token = a.dataset.token;
      const field = a.dataset.field;
      const existingValue = document.querySelector(`#current-values input[name=${field}]`).value;
      let value = prompt(`Enter new value for '${field}'':`, existingValue);
      if (value !== null) {
        if (value === "") {
          value = null;
        }
        fetch(`/admin/manage/edit-user/${token}`, {
          method: "POST",
          credentials: "same-origin",
          body: JSON.stringify({
            [field]: value,
            _csrf: document.querySelector("meta[name=csrf-token]").getAttribute("content"),
          }),
          headers: { "Content-Type": "application/json", Accept: "application/json" },
        })
          .then((res) => Promise.all([res.ok, res.json()]))
          .then(([ok, json]) => {
            const url = new URL(window.location.href);
            const params = new URLSearchParams();
            if (!ok) {
              params.set("flash", `error: ${json.error.message}`);
            } else {
              params.set("flash", `success: User's ${field} updated.`);
            }
            url.search = params.toString();
            window.location.assign(url);
          });
      }
    });
  });
</script>

<<<<<<< HEAD
<%- include("partials/admin-ban-xhr-script") %>
<%- include("partials/admin-footer") %>
=======
<%- include("partials/admin-ban-xhr-script") %> <%- include("partials/admin-footer") %>
>>>>>>> upstream/main
